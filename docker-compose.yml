version: "3"

services:
  provisioner:
    environment:
      - SUBSCRIPTS_DB_URI=mysql://scripts_db_user:scripts_db_password@scripts_db:3306/mainscripts
      - KICKSTARTS_DB_URI=mysql://scripts_db_user:scripts_db_password@scripts_db:3306/mainscripts
      - PREINSTALLSCRIPTS_DB_URI=mysql://scripts_db_user:scripts_db_password@scripts_db:3306/mainscripts
      - POSTINSTALLSCRIPTS_DB_URI=mysql://scripts_db_user:scripts_db_password@scripts_db:3306/mainscripts
      - MINIO_ACCESS_KEY=mirror_s3
      - MINIO_SECRET_KEY=mirror_s3_password
      - SERVICEDIR=src/services/provisioner
      - SERVICES=*.js
    build: .
    volumes:
      - .:/opt/pojntfx/provisioner:z
      - provisioner_node_modules:/opt/pojntfx/provisioner/node_modules:z
      - provisioner_tmp:/tmp/pojntfx/provisioner:z
      - mirror_s3:/tmp/pojntfx/provisioner/mirror
    command: npm run start--watch
    networks:
      - main
      - mainscripts
    depends_on:
      - scripts_db
  pxeboot:
    environment:
      - SERVICEDIR=src/services/pxeboot
      - SERVICES=*.js
    build: .
    volumes:
      - pxeboot_node_modules:/opt/pojntfx/provisioner/node_modules:z
      - pxeboot_tmp:/tmp/pojntfx/provisioner:z
      - pxeboot_etc:/etc:z
    command: npm run start--watch
    network_mode: host
    cap_add:
      - NET_ADMIN
    ports:
      - "57:57"
      - "67:67"
      - "69:69"
  dns:
    environment:
      - SERVICEDIR=src/services/dns
      - SERVICES=*.js
    build: .
    volumes:
      - dns_node_modules:/opt/pojntfx/provisioner/node_modules:z
      - dns_tmp:/tmp/pojntfx/provisioner:z
    command: npm run start--watch
    network_mode: host
    cap_add:
      - NET_ADMIN
    ports:
      - "53:53"
  gateway:
    environment:
      - GATEWAY_DB_URI=mysql://scripts_db_user:scripts_db_password@scripts_db:3306/mainscripts
      - SERVICEDIR=src/services/gateway
      - SERVICES=*.js
    build: .
    volumes:
      - gateway_node_modules:/opt/pojntfx/provisioner/node_modules:z
    command: npm run start--watch
    networks:
      - main
      - mainscripts
    ports:
      - 3000:3000
    depends_on:
      - pxeboot
      - provisioner
      - scripts_db
  scripts_db:
    environment:
      - MARIADB_ROOT_PASSWORD=scripts_db_root_password
      - MARIADB_USER=scripts_db_user
      - MARIADB_PASSWORD=scripts_db_password
      - MARIADB_DATABASE=mainscripts
    image: bitnami/mariadb:10.2.21
    volumes:
      - scripts_db:/bitnami/mariadb
    networks:
      - mainscripts
  mirror_s3:
    environment:
      - MINIO_ACCESS_KEY=mirror_s3
      - MINIO_SECRET_KEY=mirror_s3_password
    image: minio/minio:RELEASE.2019-02-06T21-16-36Z
    volumes:
      - mirror_s3:/data:z
    networks:
      - main
    ports:
      - 9000:9000
    command: server /data

volumes:
  provisioner_node_modules:
  provisioner_tmp:
  pxeboot_node_modules:
  pxeboot_tmp:
  pxeboot_etc:
  dns_node_modules:
  dns_tmp:
  gateway_node_modules:
  scripts_db:
  mirror_s3:

networks:
  main:
  mainscripts:
